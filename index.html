<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BR</title>
  <style>
    body {
      font-family: monospace;
      background-color: #333;
      color: white;
    }
    .fecha-actualizado {
      margin: 10px;
    }
    span.separator {
      content: '|';
      color: yellowgreen;
    }
    a.imdb {
      background-color: goldenrod;
      color: black;
      font-family: serif;
      padding: 2px 5px;
      font-size: 12px;
      font-weight: bold;
      text-decoration: none;
      border-radius: 4px;
    }
    span.added {
      font-size: 12px;
      background-color: rgb(114, 151, 39);
      padding: 2px 5px;
    }
    div.row:hover {
      background-color: #555;
    }
    span.muted {
      color: #AAA;
    }
    span.genre-tag {
      font-size: 12px;
      border: 1px solid #AAA;
      color: #AAA;
      padding: 2px 5px;
      margin-right: 2px;
      display: inline-block;
      margin-top: 2px;
    }
    span.genre-tag[data-genre] {
      cursor: pointer;
    }
    .all-genres{
      margin: .5em 0;
    }
    .genre-pill{
      display: inline-block;
      margin-right: 6px;
      margin-bottom: 6px;
      padding: 4px 8px;
      background: rgba(170,170,170,0.08);
      color: #DDD;
      border: 1px solid #DDD;
      cursor: pointer;
      font-size: 12px;
    }
    .genre-pill.active{
      background: yellowgreen;
      color: white;
      border-color: #333;
      font-weight: bold;
    }
    #list {
      display: table;
    }
    .row {
      display: table-row;
    }
    .col-imdb, .col-title, .col-added, .col-notes, .col-genres {
      display: table-cell;
      padding: 5px;
      white-space: nowrap;
    }
    .col-title, .col-notes, .col-genres {
      overflow: hidden;
      text-overflow: ellipsis;
    }
    @media (max-width: 900px) {
      html, body {
        overflow-x: hidden;
        max-width: 100vw;
      }
      #list {
        display: block;
        max-width: 100%;
      }
      .row {
        display: block;
        padding: 5px;
        margin-bottom: 10px;
        max-width: 100%;
        box-sizing: border-box;
        background-color: #444;
      }
      .col-imdb, .col-title, .col-added, .col-notes, .col-genres {
        display: block;
        margin-bottom: 8px;
        white-space: normal;
        overflow: visible;
        word-break: break-word;
        max-width: 100%;
        box-sizing: border-box;
      }
    }
    input#title-filter {
      margin: .5em 0;
      width: 99%;
      padding: .3em;
      border: 0;
      background-color: #333;
      color: white;
      border-bottom: 2px solid #AAA;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="fecha-actualizado">Actualizado a día <span class="fecha"></span></div>
  <div class="filter">
    <input type="text" id="title-filter" placeholder="Buscar por título">
  </div>
  <div id="all-genres" class="all-genres" aria-label="Filtros por género"></div>
  <div id="list"></div>
  <div class="fecha-actualizado">Actualizado a día <span class="fecha"></span></div>
</body>
<script>

  (async function() {
    let res = await fetch('data.csv')
    res = await res.text()
    window.fullList = csvToArray(res)
    renderAllGenres(window.fullList)
    printList()
  })()

  function filterResults(e) {
    if (window.filterTimeout) {
      clearTimeout(window.filterTimeout)
    }
    window.filterTimeout = setTimeout(() => {
      const text = this.value.trim().toLowerCase()
      if (window.lastSearchText === text) {
        return false
      }
      window.lastSearchText = text
      applyFilters()
    }, 1000)
    
  }

  function printRow(m){
    document.querySelector('#list').innerHTML += `
      <div class="row">
        <div class="col-imdb">
          <a class="imdb" target="_blank" href="${m[7]}">IMDb</a> #${m[0]}
        </div>
        <div class="col-title">
          <strong>${m[5]}</strong> (${m[6]})
        </div>
        <div class="col-added">
          <span class="added">Añadida: ${(m[2] || '').split('-').reverse().join('.')}</span>
        </div>
        <div class="col-notes">
          Nota IMDb: ${m[9]} | Mi nota: ${m[16] || '<span class="muted">Sin nota</span>'}${m[4] ? ' | ' + m[4] : ''}
        </div>
        <div class="col-genres">
          ${getGenreTags(m[12])}
        </div>
      </div>
    `.replace(/\|/ig, '<span class="separator">|</span>')
  }

  async function printList(list) {
    document.querySelector('#list').innerHTML = ''
    if (!list && window.fullList) {
      list = window.fullList
    }
    if(window.location.search.substr(1) === 'json'){
        document.body.innerHTML = JSON.stringify(list)
    }else{
      list.forEach(printRow)
    }
    // Fechas
    // Obtener la fecha de última modificación de data.csv
    let formatted = ''
    try {
      const res = await fetch('data.csv', { method: 'HEAD' })
      const lastModified = res.headers.get('Last-Modified')
      if (lastModified) {
      const date = new Date(lastModified)
        formatted = date.toLocaleDateString('es-ES')
      } else {
        formatted = 'desconocida'
      }
    } catch (e) {
      formatted = 'desconocida'
    }
    ([...document.querySelectorAll('.fecha-actualizado .fecha')]).forEach(node => node.textContent = formatted)
  }

  function getGenreTags(genresTxt){
    return (genresTxt || '').split(',').map(t => {
      const title = t.trim()
      if(!title) return ''
      return `<span class="genre-tag" data-genre="${title}">${title}</span>`
    }).join('')
  }

  // Tags and filtering
  window.selectedGenres = new Set();

  function renderAllGenres(list){
    const set = new Set();
    (list || []).forEach(m => {
      (m[12] || '').split(',').forEach(g => {
        const t = (g||'').trim()
        if(t) set.add(t)
      })
    })
    const container = document.querySelector('#all-genres')
    container.innerHTML = ''
    Array.from(set).sort((a,b)=>a.localeCompare(b)).forEach(g => {
      const span = document.createElement('span')
      span.className = 'genre-pill'
      span.setAttribute('data-genre', g)
      span.textContent = g
      container.appendChild(span)
    })
    updateActivePills()
  }

  function updateActivePills(){
    document.querySelectorAll('[data-genre]').forEach(el => {
      const g = (el.getAttribute('data-genre')||'').trim().toLowerCase()
      if(window.selectedGenres.has(g)) el.classList.add('active')
      else el.classList.remove('active')
    })
  }

  function toggleGenre(raw){
    const g = (raw||'').trim()
    if(!g) return
    const key = g.toLowerCase()
    if(window.selectedGenres.has(key)) window.selectedGenres.delete(key)
    else window.selectedGenres.add(key)
    updateActivePills()
    applyFilters()
  }

  function computeFilteredList(){
    let list = window.fullList || []
    const text = (document.querySelector('input#title-filter').value || '').trim().toLowerCase()
    if(text){
      list = list.filter(item => (item[5]||'').toLowerCase().includes(text) || (item[6]||'').toLowerCase().includes(text))
    }
    if(window.selectedGenres.size){
      const sel = Array.from(window.selectedGenres)
      list = list.filter(item => {
        const genres = ((item[12]||'').split(',').map(x=>x.trim().toLowerCase()).filter(Boolean))
        return sel.every(s => genres.includes(s))
      })
    }
    return list
  }

  function applyFilters(){
    const filtered = computeFilteredList()
    printList(filtered)
  }

  function csvToArray( strData, strDelimiter ){
      // Check to see if the delimiter is defined. If not,
      // then default to comma.
      strDelimiter = (strDelimiter || ",");

      // Create a regular expression to parse the CSV values.
      var objPattern = new RegExp(
          (
              // Delimiters.
              "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +

              // Quoted fields.
              "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +

              // Standard fields.
              "([^\"\\" + strDelimiter + "\\r\\n]*))"
          ),
          "gi"
          );


      // Create an array to hold our data. Give the array
      // a default empty first row.
      var arrData = [[]];

      // Create an array to hold our individual pattern
      // matching groups.
      var arrMatches = null;


      // Keep looping over the regular expression matches
      // until we can no longer find a match.
      while (arrMatches = objPattern.exec( strData )){

          // Get the delimiter that was found.
          var strMatchedDelimiter = arrMatches[ 1 ];

          // Check to see if the given delimiter has a length
          // (is not the start of string) and if it matches
          // field delimiter. If id does not, then we know
          // that this delimiter is a row delimiter.
          if (
              strMatchedDelimiter.length &&
              strMatchedDelimiter !== strDelimiter
              ){

              // Since we have reached a new row of data,
              // add an empty row to our data array.
              arrData.push( [] );

          }

          var strMatchedValue;

          // Now that we have our delimiter out of the way,
          // let's check to see which kind of value we
          // captured (quoted or unquoted).
          if (arrMatches[ 2 ]){

              // We found a quoted value. When we capture
              // this value, unescape any double quotes.
              strMatchedValue = arrMatches[ 2 ].replace(
                  new RegExp( "\"\"", "g" ),
                  "\""
                  );

          } else {

              // We found a non-quoted value.
              strMatchedValue = arrMatches[ 3 ];

          }


          // Now that we have our value string, let's add
          // it to the data array.
          arrData[ arrData.length - 1 ].push( strMatchedValue );
      }

      arrData.shift()

      arrData = arrData.filter(item => !!item[0])

      arrData.sort((a, b) => {
        if(+a[0] > +b[0]) return -1
        if(+a[0] < +b[0]) return 1
        else return 0
      })

      return arrData
  }

  document.querySelector('input#title-filter').addEventListener('keyup', filterResults)

  // Delegated click handling for any element with data-genre (both pills and row tags)
  document.addEventListener('click', function(e){
    const el = e.target.closest('[data-genre]')
    if(!el) return
    const genre = el.getAttribute('data-genre')
    toggleGenre(genre)
  })
</script>
</html>
